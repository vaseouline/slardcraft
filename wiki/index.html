<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BordSMP Wiki</title>
    <link rel="stylesheet" href="./style.css">

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<body>
    <div class="bd" id="bd">
        <b>Server Code</b>:
        <input type="text" id="code-input">
        <button onclick="startServer()" disabled id="start-button">Start Server</button>
        <hr>
        <b>IP/Domain Name:</b> play.bordsmp.jacobyng.com
        <br>
        <b>Server Status:</b>
        <span id="server-online" style="color: orange;">Requesting Status</span>
        <span id="player-count"></span>
        <br>
        <b>Server Version:</b>
        <span id="server-version"></span>
        <br>
        <span><b>Players Online:</b></span>
        <ul id="player-list" style="padding-left: 3px; margin: 0;">
        </ul>

    </div>
</body>

<script>
    var bdWidth = document.getElementById('bd').clientWidth;
    document.getElementById('bd').style.marginLeft = bdWidth/-2 + "px";
</script>

<script>
    var serverStarting = false;
    const userAction = async () => {
        const response = await fetch('https://c40kryu5o3.execute-api.us-west-1.amazonaws.com/latest/get-bordsmp-server-status');
        const myJson = await response.json(); //extract JSON from the http response
        document.getElementById('start-button').disabled = true;
        if (myJson.serverStatus === "TASK_OFFLINE" && !serverStarting) {
            document.getElementById('start-button').disabled = false;
            document.getElementById('server-online').textContent = 'Offline';
            document.getElementById('server-online').style.color = "red";
            document.getElementById('player-count').textContent = "";
        }
        else if (myJson.serverStatus === "MINECRAFT_ONLINE") {
            serverStarting = false;
            document.getElementById('server-version').textContent = myJson.serverVersion;
            document.getElementById('server-online').textContent = 'Online';
            document.getElementById('server-online').style.color = "green";
            document.getElementById('player-count').textContent = '(' + myJson.online + '/' + myJson.max + ')';

            var list = document.getElementById('player-list');
            list.innerHTML = "";
            var playerList = myJson.players;
            playerList.forEach(element => {
                var entry = document.createElement('li');
                entry.style.display = "inline";
                entry.style.paddingRight = "60px"
                var avatar = document.createElement("img");
                avatar.setAttribute("src", "https://crafatar.com/avatars/" + element.id.replace("-", ""));
                avatar.setAttribute("class", "avatar-text");
                avatar.style.paddingRight = "3px";
                entry.appendChild(avatar)

                entry.appendChild(document.createTextNode("" + element.name));
                list.appendChild(entry);
            });
        }
        else if (myJson.serverStatus === "TASK_PENDING") {
            serverStarting = false;
            document.getElementById('server-online').textContent = 'Booting Up Server';
            document.getElementById('server-online').style.color = "orange";
        }
        else if (myJson.serverStatus === "TASK_ONLINE") {
            serverStarting = false;
            document.getElementById('server-online').textContent = 'Booting Up Minecraft';
            document.getElementById('server-online').style.color = "orange";
        }
        else if (myJson.serverStatus == "TASK_RECEIVED") {
            serverStarting = false;
            document.getElementById('server-online').textContent = 'Initialization Request Received';
            document.getElementById('server-online').style.color = "orange";
        }
        else {
            document.getElementById('server-online').textContent = 'ERROR: Status Unknown';
            document.getElementById('server-online').style.color = "red";
        }

    }
    userAction()
    myInterval = window.setInterval(function () {
        userAction()
    }, 30 * 1000);

    myTimeout = window.setTimeout(function () {
        window.clearInterval(myInterval)
    }, 5 * 60 * 60 * 1000);

</script>

<script>

    const startServer = async () => {
        const response = await fetch('https://c40kryu5o3.execute-api.us-west-1.amazonaws.com/latest/start-server',
            {
                method: 'POST',
                headers: {
                    'Accept': 'applcation/json',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'code': document.getElementById('code-input').value
                })
            });
        const myJson = await response.json(); //extract JSON from the http response

        if (myJson.status == "WRONG_CODE") {
            alert("That's not the right code.")
        }
        else if (myJson.status == "STARTING_SERVER" || myJson.status == "SERVER_ALREADY_STARTED") {
            document.getElementById('start-button').disabled = true;
            const response2 = await fetch('https://c40kryu5o3.execute-api.us-west-1.amazonaws.com/latest/get-bordsmp-server-status');
            serverStarting = true;
            const myJson2 = await response2.json();
            if (document.getElementById('server-online').textContent === "Offline") {
                document.getElementById('server-online').textContent = 'Initialization Request Sent';
                document.getElementById('server-online').style.color = "orange";
                document.getElementById('player-count').textContent = "";
            }
        }
        else {
            alert("Error: Something wrong happened.")
        }
    }
</script>

</html>